#################################################################################   MINERvA DAQ Notes by Nur <nur@fnal.gov> on 07/16/2015 09:44:22 AM CDT   ####                 Summary of today's work is described below                ###################################################################################I am starting to work on spare DAQ computer "mnvonline06". Currently the computer is sitting at TEST BEAM rack. Bonnie provided me the root access to mnvonline computers (requested by Geoff). I didn't had the minerva login access to "mnvonline06". So the first step is to add myself on "mnvonline06" using my root access. So I did the folloing steps:	> kinit nur	> ssh minerva@minerva-cr-01	> ssh root@mnvonline06Change root user to minerva	> su minervaYou will be in the root directory. Go to home directory	> cdopened .k5login file  	> emacs -nw .k5login Added nur@FNAL.GOV in the file. Now I have access to "mnvonline06". Now I can setup the computer. 1st step is to copy setup-minerva-cvs.sh from mnvonline03:/home/minerva/. To do that login to "mnvonline03"	> ssh minerva@mnvonline03	> scp setup-minerva-cvs.sh minerva@mnvonline06:/home/minervathis allows for CVS downloads (this script has now been added to mnvdaqrunscripts also but doesn't help you if you can't get it from CVS).Go to mnvonline06 and source the cvs setup file.	> source setup-minerva-cvs.sh Then need to checkout mnvdaqrunscripts from cvs by doing:	> cvs checkout mnvdaqrunscriptsChecked out the git directory sam-web-client in /home/minerva using the followingcommand	> git clone http://cdcvs.fnal.gov/projects/sam-web-clientThis allows for samweb access needed when we delete old rawdata files (but only those found in sam). I also scp-ed setup_samweb.sh from mnvonline03:/home/minerva/to set the necessary paths (this file is also now in mnvdaqrunscripts).copy setup-minerva-cvs.sh from mnvonline03:/home/minerva/. To do that login to "mnvonline03"	> ssh minerva@mnvonline03	> scp setup_samweb.sh minerva@mnvonline06:/home/minervaBack to mnvonline06. I have soft linked mnvdaqrunscripts/run_runcontrol_servers.sh and mnvdaqrunscripts/slowcontrol.sh to/home/minerva/ by doing 	> ln -s /home/minerva/mnvdaqrunscripts/run_runcontrol_servers.sh run_runcontrol_servers.sh	> ln -s /home/minerva/mnvdaqrunscripts/slowcontrol.sh slowcontrol.shI then realize that maybe this would all be easier if I just edited the mnvdaqrunscripts/install.sh file toinclude most of this stuff... We will see how that goes.    to execute, do the following 	> [minerva@mnvonline06 ~]$ chmod +x mnvdaqrunscripts/install.sh 	> [minerva@mnvonline06 ~]$ ./mnvdaqrunscripts/install.sh Copied mnvonline03's .bash_profile to mnvonline05, this sets LOCALE as FNAL2 by loging in to "mnvonline03"	> ssh minerva@mnvonline03	> scp .bash_profile minerva@mnvonline06:/home/minervaI've updated to CVS the scripts used in ControlRoomTools/data_scripts for mnvonline03 and checked out the packageon mnvonline06, it's listed under Tools/ControlRoomTools/ instead of ControlRoomTools/ (this cronjobs will need to be edited toreflect this)	> cvs checkout Tools/ControlRoomToolsGeoff needed to install xterm on mnvonline05 (this needs to be done on initial setup)already done We need g++ package in order to compile and build the DAQ. Using root access one caninstall gcc etc.	> [root@mnvonline05 minervadaq]# yum install gcc-c++This package is already installed in "mnvonline06". To find if gcc is installed or what version is installed do:	> gcc --versionCurrent version is 4.4.7 and same as "mnvonline03". From Carrie - I am currently stalled by not being able to write to the /work disk. I need to change it's permissions.  - Bonnie has been kind enough to do this for me! And on we go.Made the following directories in /work/ : conditions, data, data_vault, logs, software (various subdirectories will still needto be made). You will need to login as root to change the permission of the work directory for minerva user in oder to make these directories. So do the following:	> ssh root@mnvonline06	> mkdir /work	> cd ..	> chmod 777 work	> exitBack to mnvonline06 as minerva		> cd /work	> mkdir archive	> mkdir conditions	> mkdir data	> mkdir data_vault	> mkdir logs	> mkdir softwareIn /work/logs/ make the following subdirectories : copy_logs, deletion_logs, etclean	> cd /work/logs/	> mkdir copy_logs	> mkdir deletion_logs	> mkdir etclean
in /work/data/ make the following subdirectories : data_vault, etsys, logs, rawdata, sam	> cd /work/data/	> mkdir data_vault	> mkdir etsys	> mkdir logs	> mkdir rawdata	> mkdir samin /work/data/rawdata/, /work/data/logs/ and /work/data/sam/ make the following subdirectory in all three : copied	> mkdir /work/data/rawdata/copied	> mkdir /work/data/logs/copied	> mkdir /work/data/sam/copiedOR

	> mkdir {/work/archive,/work/conditions,/work/data,/work/data_vault,/work/logs,/work/software}
	> mkdir {/work/logs/copy_logs,/work/logs/deletion_logs,/work/logs/etclean}	> mkdir {/work/data/data_vault,/work/data/etsys,/work/data/logs,/work/data/rawdata,/work/data/sam}
	> mkdir {/work/data/rawdata/copied,/work/data/logs/copied,/work/data/sam/copied}Runcontrol was checked out of CVS to /work/software/ using the following command	> cd /work/software	> cvs checkout mnvruncontrolFrom CVS, I am checking out the MParamFiles directory (needed for hvon.hwcfg and hvoff.hwcfg). I did the following steps in home directory	> source setup-minerva-cvs.shafter sourceing for cvs, change directory to /work/conditions	> cd /work/conditions	> cvs checkout MParamFiles**I was getting permission error (this is due to minerva didn't had writing previlages to /work directory. Changing the previlages as root solved the problem.)    from there cd to MParamFiles/data/DAQ/hardware_config/  create softlinks for beam and LI running (used by RunControl)	> cd MParamFiles/data/DAQ/hardware_config/	> ln -s hvon.hwcfg beam.hwcfg	> ln -s hvon.hwcfg li.hwcfg  next, create soft links in the home directory, cd back to /home/minerva/ (the detector experts uses this softlink from home directory)	> cd 	> ln -s /work/conditions/MParamFiles/data/DAQ/hardware_config/hvon.hwcfg hvon.hwcfg	> ln -s /work/conditions/MParamFiles/data/DAQ/hardware_config/hvoff.hwcfg hvoff.hwcfg   - Trying to run the TestSuite.cpp code, getting some failures  - in /fermihardware/include/MinervaDAQSizes.h, make sure that 'ADCFrameMaxSize = 453' for FEB v91In /work/software/ I issued the following command to download the DAQ software (You need to be in the software developer list to get access of the git repository. If you are not, then email Gabriel Perdue <perdue@fnal.gov>. If you are still struggling then submit a servise now ticket.). Create croce directory. 	> mkdir /work/software/croce	> cd /work/software/croce	> git clone ssh://p-minervadaq@cdcvs.fnal.gov/cvs/projects/minervadaq	> cd minervadaq/	> git pull	(this needs to be done so that you can write to the repository later)From Carrie - Need to check that sequencer error fix is there and that the array size for the CAEN crate is 10 and not 4, so we can see both crates, not just crate 0Slowcontrol was added in /work/software/croce/ by issuing the following commands	> cd /work/software/croce	> git clone ssh://p-mnv-configurator@cdcvs.fnal.gov/cvs/projects/mnv-configurator	> cd mnv-configurator/	> git pullback in /work/software/ a soft link 'mnvconfigurator' was added to point to the right directory in croce/	> cd /work/software	> ln -s croce/mnv-configurator/ mnvconfiguratorTrying to compile the daq under the -DNUMI option. Copied the option file from mvonline05 by doing 	> scp /work/software/croce/minervadaq/minervadaq/options/mnvonline05.opts minerva@mnvonline06:/work/software/croce/minervadaq/minervadaq/options/Check if there is an existing option file for mnvonline06 to compile with different option. Chnage the file name to something else e.g; mnvonline06_old_dont_use.opts. Then create a option file with -DNUMI option. In the following directory /work/software/minervadaq/minervadaq/options, get a copy for mnvonline06
	> cd /work/software/croce/minervadaq/minervadaq/options/	> cp mnvonline05.opts mnvonline06.opts Go to directory	> cd /work/software/croce/minervadaq/minervadaqSource setup the DAQ enviornment file	> source setupdaqenv.sh Compile DAQ#	> ./complier.sh # --old, not woking	> . compiler.sh(failed to compile, need help! Getting the following error)---------------Controller.cpp: In member function ‘int Controller::Initialize()’:Controller.cpp:155: error: cannot convert ‘short unsigned int*’ to ‘unsigned int*’ for argument ‘3’ to ‘CVErrorCodes CAENVME_ReadRegister(int32_t, CVRegisters, unsigned int*)’make[2]: *** [Controller.o] Error 1make[2]: Leaving directory `/work/software/croce/minervadaq/minervadaq/fermihardware/src'gmake[1]: *** [hardware-lib] Error 2gmake[1]: Leaving directory `/work/software/croce/minervadaq/minervadaq'gmake: *** [relink] Error 2---------------g++ -O3                  -Werror -Wall -DLINUX -fPIC -I/work/software/croce/minervadaq/minervadaq/sqlite/include/ -I/work/software/croce/minervadaq/minervadaq/include -I/work/software/CAENVMElib/include -I/usr/local/include -I/work/software/croce/minervadaq/minervadaq/fermihardware/include  -I/work/software/croce/minervadaq/minervadaq/workers/include  -I/work/software/croce/minervadaq/minervadaq/event_structure/include -I/work/software/croce/minervadaq/minervadaq/event_builder/include -I/work/software/croce/minervadaq/minervadaq/et_9.0/src/libsrc -DGOFAST            -DCAEN_2_7   -DNUMI -c Controller.cpp -o Controller.o
In file included from Controller.cpp:6:
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:11:26: error: CAENVMEtypes.h: No such file or directory
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:12:24: error: CAENVMElib.h: No such file or directory
In file included from Controller.cpp:6:
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:25: error: ‘CVBoardTypes’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:26: error: ‘CVAddressModifier’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:27: error: ‘CVDataWidth’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:46: error: ‘CVAddressModifier’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:47: error: ‘CVDataWidth’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:48: error: ‘CVBoardTypes’ does not name a type
/work/software/croce/minervadaq/minervadaq/fermihardware/include/Controller.h:49: error: ‘CVBoardTypes’ does not name a type
Controller.cpp: In constructor ‘Controller::Controller(int, int)’:
Controller.cpp:17: error: ‘addressModifier’ was not declared in this scope
Controller.cpp:17: error: ‘cvA24_U_DATA’ was not declared in this scope
Controller.cpp:18: error: ‘dataWidth’ was not declared in this scope
Controller.cpp:18: error: ‘cvD16’ was not declared in this scope
Controller.cpp:19: error: ‘controllerType’ was not declared in this scope
Controller.cpp:19: error: ‘cvV2718’ was not declared in this scope
Controller.cpp:20: error: ‘bridgeType’ was not declared in this scope
Controller.cpp:20: error: ‘cvA2818’ was not declared in this scope
Controller.cpp: In destructor ‘Controller::~Controller()’:
Controller.cpp:34: error: ‘CAENVME_End’ was not declared in this scope
Controller.cpp: At global scope:
Controller.cpp:45: error: ‘CVAddressModifier’ does not name a type
Controller.cpp:51: error: ‘CVDataWidth’ does not name a type
Controller.cpp:57: error: ‘CVBoardTypes’ does not name a type
Controller.cpp:63: error: ‘CVBoardTypes’ does not name a type
Controller.cpp: In member function ‘std::string Controller::ReportError(int) const’:
Controller.cpp:86: error: ‘cvSuccess’ was not declared in this scope
Controller.cpp:89: error: ‘cvBusError’ was not declared in this scope
Controller.cpp:92: error: ‘cvCommError’ was not declared in this scope
Controller.cpp:95: error: ‘cvGenericError’ was not declared in this scope
Controller.cpp:98: error: ‘cvInvalidParam’ was not declared in this scope
Controller.cpp:101: error: ‘cvTimeoutError’ was not declared in this scope
Controller.cpp: In member function ‘int Controller::Initialize()’:
Controller.cpp:127: error: ‘controllerType’ was not declared in this scope
Controller.cpp:128: error: ‘CAENVME_Init’ was not declared in this scope
Controller.cpp:143: error: ‘CAENVME_BoardFWRelease’ was not declared in this scope
Controller.cpp:153: error: ‘CVRegisters’ was not declared in this scope
Controller.cpp:153: error: expected ‘;’ before ‘registerAddress’
Controller.cpp:155: error: ‘registerAddress’ was not declared in this scope
Controller.cpp:155: error: ‘CAENVME_ReadRegister’ was not declared in this scope
make[2]: *** [Controller.o] Error 1
make[2]: Leaving directory `/work/software/croce/minervadaq/minervadaq/fermihardware/src'
gmake[1]: *** [hardware-lib] Error 2
gmake[1]: Leaving directory `/work/software/croce/minervadaq/minervadaq'
gmake: *** [relink] Error 2---------------

Copied file from current DAQ machine to the new machine as root 
	> scp /usr/include/CAENVMElib.h root@mnvonline06:/usr/include
	> scp /usr/include/CAENVMEoslib.h root@mnvonline06:/usr/include
	> scp /usr/include/CAENVMEtypes.h root@mnvonline06:/usr/include
---------------
Still getting error:
---------------
g++ -O3                  -Werror -Wall -DLINUX -fPIC -I/work/software/croce/minervadaq/minervadaq/sqlite/include/ -I/work/software/croce/minervadaq/minervadaq/include -I/work/software/CAENVMElib/include -I/usr/local/include -I/work/software/croce/minervadaq/minervadaq/fermihardware/include  -I/work/software/croce/minervadaq/minervadaq/workers/include  -I/work/software/croce/minervadaq/minervadaq/event_structure/include -I/work/software/croce/minervadaq/minervadaq/event_builder/include -I/work/software/croce/minervadaq/minervadaq/et_9.0/src/libsrc -DGOFAST            -DCAEN_2_7   -DNUMI -c Controller.cpp -o Controller.o
Controller.cpp: In member function ‘int Controller::Initialize()’:
Controller.cpp:155: error: cannot convert ‘short unsigned int*’ to ‘unsigned int*’ for argument ‘3’ to ‘CVErrorCodes CAENVME_ReadRegister(int32_t, CVRegisters, unsigned int*)’
make[2]: *** [Controller.o] Error 1
make[2]: Leaving directory `/work/software/croce/minervadaq/minervadaq/fermihardware/src'
gmake[1]: *** [hardware-lib] Error 2
gmake[1]: Leaving directory `/work/software/croce/minervadaq/minervadaq'
gmake: *** [relink] Error 2
---------------

For smaller changes in the configuration, do a "gmake all" in the same directory. Make a soft link of setupdaqenv.sh in the home directory	> cd 	> ln -s /home/minerva/mnvdaqrunscripts/setupdaqenv.sh setupdaqenv.shAdd the following user to the /home/minerva/.k5login list	> minerva-online/minerva/minerva-om.fnal.gov@FNAL.GOVSecure copy the following keytab file from mnvonline03 (after making the /home/minerva/Krb5 directory on mnvonline06) This is needed to kerberize the machine as minerva-om. Login in to mnvonline03 and do the following	> cd	> mkdir Krb5Login to mnvonline03 to copy the krb-s.keytab file.	> ssh minerva@mnvonline03		> scp /home/minerva/Krb5/krb-s.keytab minerva@mnvonline06.fnal.gov:/home/minerva/Krb5From Carrie - Looks like slowcontrol is already running version 2.10 (it must have been updated for TestBeam running)and ncrates is already set to two! We will need to keep an eye on the number of tries (ntry1) it runs when findingthe hardware (when calling ConfigCROCEsREFE), which can cause short or significantly long delays when run over both crates. Setting up and configuring RunControl (RC)!!   Go to home directory and make soft links of the following files by doing (First check if it alraedy exist and paths are correct. Don't need to reapet if everythings looks good.)	> cd 	> ln -s /home/minerva/mnvdaqrunscripts/configure_runcontrol.sh configure_runcontrol.sh	> ln -s /home/minerva/mnvdaqrunscripts/configure_runseries.sh configure_runseries.sh	 Open RunControl configurator in /home/minerva using	> ./configure_runcontrol.sh   In "Show these options..." check the following boxes : Master node, Readout nodeFor the actual settings, log on to mnvonline03 and copy all the values.Make all necessary changes on each tab form mnvonline03 configuration settings. Setting up the necessary RC processes (readout_dispatcher, data_acqisition_manager on multiple machines in the correct order) :	> In the script /home/minerva/mnvdaqrunscripts/defs_mnvonline set MNVDAQ to mnvonline06.fnal.gov	> In the script /home/minerva/mnvdaqrunscripts/run_runcontrol_servers.sh set MASTER_NODE to mnvonline06.fnal.govCommitted to CVS scripts from mnvonline03 (readout_dispatcher_start.sh and data_acqisition_manager_start.sh) to mnvdaqrunscripts cvs repository and added them to the directory on mnvonline06. I then made soft links to those two files in /home/minerva area 	> cd	> ln -s mnvdaqrunscripts/readout_dispatcher_start.sh readout_dispatcher_start.sh	> ln -s mnvdaqrunscripts/data_acquisistion_manager_start.sh data_acquisistion_manager_start.shWhen trying to take data, the order of starting these processes matter : Readout Dispatcher runs first, and then Data Acquisition Manager on mnvonline06The script run_runcontrol_servers.sh starts these processes in the correct order.   - Need to install pySerial for LI box running : as root issue the following    [root@mnvonline05 ~]$ yum install python-setuptools  (this should have already been done when the computer was set up)   [root@mnvonline05 ~]$ easy_install pyserial pen RunControl in /home/minerva using > . runcontrol.sh  Before connecting make sure that the Hostname says mnvonline05.fnal.gov 	- In $DAQROOT/fermihardware/src/EChannels.cpp, uncomment out the v91 config line, and comment out for v95.   It should looks like this while we are running FEB v91  (*** THIS IS NO LONGER NEEDED IF THE REPOSITORY IS UP TO DATE ***) 	    //if using FEB v91                                                                                    config->SetFourBitHitEncoding();    //if using FEB v95                                                                                    //config->SetFiveBitHitEncoding();    - Also, in $DAQROOT/fermihardware/include/Controller.h, the following needs to be set to (this should be in the git repository but is not :( )  (*** THIS IS NO LONGER NEEDED IF THE REPOSITORY IS UP TO DATE ***)       char firmware[10];  (instead of firware[1])   ------------------------------------------------------------* Configure slow controlsGeneral - mostly ok. Chnage the notification email.Hardware - select the options "wait for response from LI box" and "LI box is enabled", Change the size of the readout glob to 120000 from 49152. Number of corce is 60. Log file locations - 	old "/work/data/logs/readout_dispatcher.log,	new "/work/logs/readout_dispatcher.log"			old "/tmp/runcontrol.log", 			new "/work/logs/runcontrol.log"			old "/work/data/logs/postoffice.log",		new "/work/logs/postoffice.log"			old "/work/logs/om_dispatcher.log", 		new "/work/logs/om_dispatcher.log"			old "/work/logs/beamline_dispatcher.log", 	new "/work/logs/beamline_dispatcher.log"			old "/work/logs/data_acquisition_manager.log",	new "/work/logs/data_acquisition_manager.log"Master node - In nodes to notify when the DAQ manager is is ready, remove li-only mnvonline0.fnal.gov and li-only mnvonline1.fnal.govReadout nodes - seems to be okSocket setup - seems to be okTop left corener: show these options select the optins master node and readout node save the configuration using save button------------------------------------------------------------In minerva@minervacr-01Change mnvdaqrunscripts/defs_mnvonline set the MNVDAQ to mnvonline06Need to change for 06[nearonline@mnvonlinelogger4 event_builder]/scratch/nearonline/mirror/minervadaq-croce/minervadaq/event_buildersrc/EventBuilder.cpp------------------------------------------------------------Fix gedit warning message problemksuAuthenticated nur@FNAL.GOVAccount root: authorization for nur@FNAL.GOV successfulChanging uid to root (0)[root@mnvonline06 minerva]# yum --enablerepo=epel list[root@mnvonline06 minerva]# yum --enablerepo=epel | grep gtk[root@mnvonline06 minerva]# yum --enablerepo=epel install PackageKit-gtk-module[root@mnvonline06 minerva]# exit[minerva@mnvonline06 ~]$ mkdir .local[minerva@mnvonline06 ~]$ mkdir .local/share------------------------------------------------------------PCI Driver:

Check if the driver is loaded 
-> lsmod | grep a2818 
Unload the driver: 
-> rmmod a2818 
Load driver:
Now load the driver. 
[root@mnvonline05 A2818Drv]# cd /work/software/CAENVMElib/A2818Drv 
[root@mnvonline05 A2818Drv]# ./a2818_load 

----Login as root on mnvonline05. 

Unload driver with rmmod command. 
root@mnvonline05 A2818Drv]# rmmod a2818 
ERROR: Module a2818 is in use 

I think that the readout dispatcher is attached to the driver. Nur restarts all the run control processes which includes the readout dispatcher. 

Now the driver unloads. 
[root@mnvonline05 A2818Drv]# rmmod a2818 

Now load the driver. 
[root@mnvonline05 A2818Drv]# cd /work/software/CAENVMElib/A2818Drv 
[root@mnvonline05 A2818Drv]# ./a2818_load 
[root@mnvonline05 A2818Drv]# lsmod | grep a2818 
a2818 10420 0------------------------------------------------------------
